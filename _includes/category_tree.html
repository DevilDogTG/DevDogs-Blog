{%- comment -%}
  Recursive category tree renderer.
  Usage:
    {% include category_tree.html posts=site.posts depth=0 %}

  - Groups posts by categories[depth] and recurses until no deeper level.
  - Renders a nested <ul> list with counts per category (including descendants).
{%- endcomment -%}

{%- assign groups = include.posts | group_by_exp: 'p', 'p.categories[include.depth]' -%}
{%- assign groups = groups | where_exp: 'g','g.name' | sort: 'name' -%}

{%- for g in groups -%}
  {%- assign next_depth = include.depth | plus: 1 -%}
  {%- assign next_groups = g.items | group_by_exp: 'p', 'p.categories[next_depth]' -%}
  {%- assign has_children = false -%}
  {%- for ng in next_groups -%}
    {%- if ng.name -%}
      {%- assign has_children = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}

  <li class="cat-level-{{ include.depth }}">
    {%- if has_children -%}
      <details>
        <summary>
          <span class="cat-name">{{ g.name }}</span>
          <span class="cat-count">{{ g.items | size }}</span>
        </summary>
        <ul>
          {%- include category_tree.html posts=g.items depth=next_depth -%}
        </ul>
      </details>
    {%- else -%}
      <span class="cat-name">{{ g.name }}</span>
      <span class="cat-count">{{ g.items | size }}</span>
    {%- endif -%}
  </li>
{%- endfor -%}

